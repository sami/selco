---
import { projects, standaloneTools } from '../../data/projects';

const RAW_BASE = import.meta.env.BASE_URL;
const base = RAW_BASE.endsWith('/') ? RAW_BASE : `${RAW_BASE}/`;
const currentPath = Astro.url.pathname;

const normalize = (path: string) => path.endsWith('/') ? path.slice(0, -1) : path;
const current = normalize(currentPath);

// Helper to check active state
const isActive = (href: string) => {
    const normHref = normalize(href);
    return href === base ? current === normalize(base) : current.startsWith(normHref);
};
---

<aside class="sidebar-container">
  <!-- Mobile Toggle Header -->
  <button id="sidebar-toggle" class="sidebar-mobile-toggle" aria-expanded="false">
    In this section <i class="fas fa-caret-down transition-transform"></i>
  </button>

  <div id="sidebar-content" class="sidebar-content">
    <div class="sidebar-header desktop-only">
      Navigation
    </div>
    
    <ul class="sidebar-list">
        <li>
            <a href={base} class={isActive(base) ? 'active' : ''}>
                Home
            </a>
        </li>

        <li class="sidebar-section">
            <span class="section-title">Handy Calculators</span>
        </li>
        <li>
            <a href={`${base}calculators/unit-converter/`} class={isActive(`${base}calculators/unit-converter/`) ? 'active' : ''}>
                Unit Converter
            </a>
        </li>

        <li class="sidebar-section">
            <span class="section-title">Project Calculators</span>
        </li>
        <li>
            <a href={`${base}projects/tiling/`} class={isActive(`${base}projects/tiling/`) ? 'active' : ''}>
                Tiling
            </a>
        </li>
        <li>
            <a href={`${base}projects/masonry/`} class={isActive(`${base}projects/masonry/`) ? 'active' : ''}>
                Masonry
            </a>
        </li>
        <li>
            <a href={`${base}projects/`} class={isActive(`${base}projects/`) ? 'active' : ''}>
                Concrete &amp; Groundworks
            </a>
        </li>
    </ul>
  </div>
</aside>

<script>
  // Mobile Sidebar Toggle
  const toggle = document.getElementById('sidebar-toggle');
  const content = document.getElementById('sidebar-content');
  const icon = toggle?.querySelector('.fa-caret-down');

  toggle?.addEventListener('click', () => {
    const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
    toggle.setAttribute('aria-expanded', (!isExpanded).toString());
    content?.classList.toggle('open');
    icon?.classList.toggle('rotate-180');
  });

  // Accordion Toggles
  const accordions = document.querySelectorAll('.accordion-toggle');
  accordions.forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault(); // Prevent accidental navigation
        const item = btn.closest('.accordion-item');
        item?.classList.toggle('expanded');
        const icon = btn.querySelector('i');
        icon?.classList.toggle('rotate-180');
    });
  });
</script>

<style>
  .sidebar-container {
    margin-top: 10px;
  }
  
  /* Mobile Toggle */
  .sidebar-mobile-toggle {
    display: none;
    width: 100%;
    background-color: #00264d;
    color: white;
    padding: 10px 15px;
    font-weight: 700;
    font-size: 1rem;
    border: none;
    text-align: left;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    margin-bottom: 0;
  }

  /* Header */
  .sidebar-header {
    background-color: #00264d;
    color: white;
    padding: 12px 15px;
    font-weight: 700;
    font-size: 0.95rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* List Styling */
  .sidebar-list {
    background-color: #f4f4f4;
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .sidebar-list li a {
    display: block;
    padding: 10px 15px;
    border-bottom: 1px solid #ddd;
    font-size: 0.9rem;
    color: #555;
    position: relative;
    display: flex;
    align-items: center;
    text-decoration: none;
  }
  
  /* Standard Arrow for links */
  .sidebar-list > li > a::before {
    content: '\f054';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    font-size: 0.6rem;
    margin-right: 10px;
    color: #999;
  }

  .sidebar-section {
    background-color: #e8e8e8 !important;
    border-bottom: 1px solid #ddd !important;
    padding: 0 !important;
  }

  .section-title {
    display: block;
    padding: 10px 15px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    color: #666;
    letter-spacing: 0.5px;
  }

  /* Hover States */
  .sidebar-list li a:hover {
    background-color: #fff;
    color: #004B8D;
  }
  .sidebar-list li a.active {
    font-weight: 700;
    color: #333;
    background-color: #fff;
  }

  /* Accordion Styling */
  .accordion-header {
      display: flex;
      align-items: stretch;
      background-color: #f4f4f4;
      border-bottom: 1px solid #ddd;
  }
  
  .section-link {
      flex: 1;
      font-weight: 800;
      color: #00264d !important;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 15px !important;
      border-bottom: none !important;
  }
  /* Remove default arrow for section headers */
  .section-link::before {
      display: none; 
  }

  .accordion-toggle {
      background: none;
      border: none;
      border-left: 1px solid #ddd;
      padding: 0 15px;
      color: #00264d;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
  }

  .accordion-content {
      display: none;
      list-style: none;
      padding: 0;
      margin: 0;
      background-color: #fff;
  }
  
  .accordion-item.expanded .accordion-content {
      display: block;
  }

  .accordion-content li a {
      padding-left: 25px; /* Indent properties */
      font-size: 0.85rem;
  }

  /* Highlight Link (Unit Conversions) */
  .highlight-link {
      font-weight: 700;
      color: #004B8D !important;
      background-color: #e6f0ff !important;
  }

  /* Utilities */
  .desktop-only { display: flex; }
  .rotate-180 { transform: rotate(180deg); }
  .transition-transform { transition: transform 0.3s ease; }
  .mr-2 { margin-right: 0.5rem; }
  .text-brand-yellow { color: #FFCD00; }

  @media (max-width: 1024px) {
    .sidebar-container { margin-top: 0; }
    .sidebar-mobile-toggle { display: flex; }
    .desktop-only { display: none; }
    .sidebar-content { display: none; }
    .sidebar-content.open { display: block; }
  }
</style>
